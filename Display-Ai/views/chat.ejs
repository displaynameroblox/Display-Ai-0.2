<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Chat</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{background:#060606;color:#f3f3f3;font-family:Inter,system-ui,sans-serif;margin:0;padding:18px}
    .top{display:flex;align-items:center;gap:12px}
    .btn{background:#f55;color:#fff;padding:8px 12px;border-radius:8px;text-decoration:none}
    #chatLog{margin-top:16px;max-height:60vh;overflow:auto;padding-right:6px}
    .msg{background:#101010;padding:10px;border-radius:8px;margin-bottom:10px}
    .msg .who{color:#aaa;font-size:12px}
    textarea{width:100%;height:90px;padding:10px;border-radius:8px;border:1px solid #222;background:#0b0b0b;color:#fff}
    .controls{display:flex;gap:8px;align-items:center;margin-top:8px}
    .small{color:#999;font-size:13px}
  </style>
</head>
<body>
  <div class="top">
    <a href="/" class="btn">‚Üê Dashboard</a>
    <h2 style="margin:0">Chat as <%= username %></h2>
  </div>

  <div id="chatLog"></div>

  <div style="margin-top:12px">
    <textarea id="prompt" placeholder="Say something..."></textarea>
    <div class="controls">
      <button id="sendBtn" class="btn">Send</button>
      <div class="small">AI name: <strong><%= user.aiName || "Display" %></strong></div>
    </div>
  </div>

<script>
  const userId = "<%= username %>";
  const chatLog = document.getElementById("chatLog");
  const prompt = document.getElementById("prompt");
  const sendBtn = document.getElementById("sendBtn");

  function appendMessage(who, text) {
    const div = document.createElement("div");
    div.className = "msg";
    div.innerHTML = `<div class="who">${who}</div><div>${text}</div>`;
    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  sendBtn.addEventListener("click", async () => {
    const text = prompt.value.trim();
    if (!text) return;
    appendMessage("You", text);
    prompt.value = "";
    try {
      const res = await fetch("/chat", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ userId, prompt: text })
      });
      const data = await res.json();
      if (data && data.reply) {
        appendMessage("<%= user.aiName %>", data.reply);
      } else {
        appendMessage("System", "No reply from server.");
      }
    } catch (e) {
      appendMessage("System", "Network error: " + e.message);
    }
  });

  // optional: enter to send (shift+enter to newline)
  prompt.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendBtn.click();
    }
  });
</script>
</body>
</html>